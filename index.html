<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>OpenClash é…ç½®è½¬æ¢å™¨</title>
<meta name="description" content="åœ¨æµè§ˆå™¨ä¸­å°† Clash è®¢é˜… YAML ä¸€é”®è½¬æ¢ä¸º OpenClash è½¯è·¯ç”±é…ç½®ï¼Œæ”¯æŒæ™®é€šç‰ˆå’Œ Lite ç²¾ç®€ç‰ˆ">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<style>
  /* ==================== Reset & Base ==================== */
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  :root {
    --bg-primary: #000000;
    --bg-card: rgba(8, 12, 16, 0.9);
    --border-color: rgba(0, 240, 255, 0.12);
    --border-glow: rgba(0, 240, 255, 0.4);
    --text-primary: #e8edf2;
    --text-secondary: #8899aa;
    --text-muted: #506070;
    --cyan: #00F0FF;
    --green: #00FF88;
    --blue: #3B82F6;
    --red: #EF4444;
    --amber: #FBBF24;
    --glow-cyan: 0 0 12px rgba(0, 240, 255, 0.5);
    --glow-green: 0 0 12px rgba(0, 255, 136, 0.5);
    --radius: 16px;
    --radius-sm: 10px;
    --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  }

  body {
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
    background: var(--bg-primary);
    color: var(--text-primary);
    min-height: 100vh;
    overflow-x: hidden;
    line-height: 1.6;
  }

  /* ==================== Background Effects ==================== */
  body::before {
    content: '';
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    background:
      radial-gradient(ellipse 600px 400px at 20% 10%, rgba(0, 240, 255, 0.04) 0%, transparent 70%),
      radial-gradient(ellipse 500px 400px at 80% 90%, rgba(0, 255, 136, 0.03) 0%, transparent 70%);
    pointer-events: none;
    z-index: 0;
  }

  /* ==================== Container ==================== */
  .container {
    position: relative;
    z-index: 1;
    max-width: 900px;
    margin: 0 auto;
    padding: 40px 24px 80px;
  }

  /* ==================== Header ==================== */
  .header {
    text-align: center;
    margin-bottom: 48px;
  }

  .header-badge {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 6px 16px;
    border-radius: 9999px;
    background: rgba(0, 240, 255, 0.06);
    border: 1px solid rgba(0, 240, 255, 0.2);
    font-size: 12px;
    font-weight: 600;
    color: var(--cyan);
    letter-spacing: 0.5px;
    text-transform: uppercase;
    margin-bottom: 20px;
  }

  .header-badge::before {
    content: '';
    width: 6px;
    height: 6px;
    border-radius: 50%;
    background: var(--green);
    box-shadow: 0 0 6px var(--green), 0 0 12px rgba(0, 255, 136, 0.4);
    animation: pulse 2s ease-in-out infinite;
  }

  @keyframes pulse {
    0%, 100% { opacity: 1; transform: scale(1); }
    50%      { opacity: 0.5; transform: scale(0.8); }
  }

  .header h1 {
    font-size: 2.5rem;
    font-weight: 800;
    color: var(--cyan);
    text-shadow: 0 0 30px rgba(0, 240, 255, 0.3), 0 0 60px rgba(0, 240, 255, 0.1);
    margin-bottom: 12px;
    letter-spacing: -0.5px;
  }

  .header p {
    color: var(--text-secondary);
    font-size: 15px;
    max-width: 520px;
    margin: 0 auto;
  }

  /* ==================== Card ==================== */
  .card {
    background: var(--bg-card);
    -webkit-backdrop-filter: blur(16px);
    backdrop-filter: blur(16px);
    border: 1px solid var(--border-color);
    border-radius: var(--radius);
    padding: 32px;
    margin-bottom: 24px;
    transition: var(--transition);
  }

  .card:hover {
    border-color: var(--border-glow);
    box-shadow: 0 0 30px rgba(0, 240, 255, 0.08);
  }

  .card-title {
    font-size: 16px;
    font-weight: 700;
    color: var(--text-primary);
    margin-bottom: 20px;
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .card-title .icon {
    width: 32px;
    height: 32px;
    border-radius: var(--radius-sm);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 16px;
    flex-shrink: 0;
  }

  .card-title .icon.upload  { background: rgba(0, 240, 255, 0.1); }
  .card-title .icon.output  { background: rgba(0, 255, 136, 0.1); }
  .card-title .icon.log     { background: rgba(251, 191, 36, 0.1); }

  /* ==================== Drop Zone ==================== */
  .drop-zone {
    border: 2px dashed rgba(0, 240, 255, 0.2);
    border-radius: var(--radius-sm);
    padding: 48px 24px;
    text-align: center;
    cursor: pointer;
    transition: var(--transition);
    position: relative;
  }

  .drop-zone:hover,
  .drop-zone.drag-over {
    border-color: var(--cyan);
    background: rgba(0, 240, 255, 0.03);
    box-shadow: inset 0 0 40px rgba(0, 240, 255, 0.03), var(--glow-cyan);
  }

  .drop-zone .upload-icon {
    font-size: 40px;
    margin-bottom: 12px;
    display: block;
    opacity: 0.8;
  }

  .drop-zone .main-text {
    font-size: 15px;
    font-weight: 600;
    color: var(--text-primary);
    margin-bottom: 6px;
  }

  .drop-zone .sub-text {
    font-size: 13px;
    color: var(--text-muted);
  }

  .drop-zone input[type="file"] {
    display: none;
  }

  /* ==================== File info ==================== */
  .file-info {
    display: none;
    align-items: center;
    gap: 14px;
    padding: 16px;
    background: rgba(0, 240, 255, 0.04);
    border: 1px solid rgba(0, 240, 255, 0.12);
    border-radius: var(--radius-sm);
    margin-top: 16px;
  }

  .file-info.visible { display: flex; }

  .file-info .file-icon {
    width: 40px;
    height: 40px;
    border-radius: var(--radius-sm);
    background: var(--cyan);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 18px;
    flex-shrink: 0;
    box-shadow: var(--glow-cyan);
  }

  .file-info .file-details {
    flex: 1;
    min-width: 0;
  }

  .file-info .file-name {
    font-size: 14px;
    font-weight: 600;
    color: var(--text-primary);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .file-info .file-size {
    font-size: 12px;
    color: var(--text-muted);
  }

  .file-info .file-remove {
    width: 28px;
    height: 28px;
    border-radius: 50%;
    border: none;
    background: rgba(239, 68, 68, 0.12);
    color: var(--red);
    cursor: pointer;
    font-size: 14px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: var(--transition);
    flex-shrink: 0;
  }

  .file-info .file-remove:hover {
    background: rgba(239, 68, 68, 0.25);
    box-shadow: 0 0 10px rgba(239, 68, 68, 0.3);
  }

  /* ==================== Convert Button ==================== */
  .convert-btn {
    width: 100%;
    padding: 16px;
    border: 1px solid var(--cyan);
    border-radius: var(--radius-sm);
    background: rgba(0, 240, 255, 0.08);
    color: var(--cyan);
    font-family: 'Inter', sans-serif;
    font-size: 15px;
    font-weight: 700;
    cursor: pointer;
    transition: var(--transition);
    position: relative;
    margin-top: 24px;
    letter-spacing: 0.3px;
    text-shadow: 0 0 8px rgba(0, 240, 255, 0.4);
  }

  .convert-btn:hover {
    background: rgba(0, 240, 255, 0.15);
    box-shadow: var(--glow-cyan), 0 0 30px rgba(0, 240, 255, 0.15);
    transform: translateY(-2px);
  }

  .convert-btn:active { transform: translateY(0); }

  .convert-btn:disabled {
    opacity: 0.3;
    cursor: not-allowed;
    transform: none !important;
    box-shadow: none !important;
    border-color: rgba(0, 240, 255, 0.2);
  }

  /* ==================== Results ==================== */
  .results-section {
    display: none;
  }

  .results-section.visible { display: block; }

  .result-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 18px 20px;
    background: rgba(8, 12, 16, 0.6);
    border: 1px solid rgba(0, 240, 255, 0.08);
    border-radius: var(--radius-sm);
    margin-bottom: 12px;
    transition: var(--transition);
  }

  .result-item:hover {
    border-color: rgba(0, 240, 255, 0.2);
    box-shadow: 0 0 20px rgba(0, 240, 255, 0.05);
  }

  .result-item .result-info {
    display: flex;
    align-items: center;
    gap: 14px;
    min-width: 0;
    flex: 1;
  }

  .result-item .result-badge {
    padding: 4px 10px;
    border-radius: 6px;
    font-size: 11px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    white-space: nowrap;
    flex-shrink: 0;
  }

  .result-badge.full {
    background: rgba(0, 240, 255, 0.1);
    color: var(--cyan);
    border: 1px solid rgba(0, 240, 255, 0.2);
  }

  .result-badge.lite {
    background: rgba(0, 255, 136, 0.08);
    color: var(--green);
    border: 1px solid rgba(0, 255, 136, 0.2);
  }

  .result-item .result-meta {
    flex: 1;
    min-width: 0;
  }

  .result-item .result-name {
    font-size: 14px;
    font-weight: 600;
    color: var(--text-primary);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .result-item .result-stats {
    font-size: 12px;
    color: var(--text-muted);
    margin-top: 2px;
  }

  .download-btn {
    padding: 8px 20px;
    border: 1px solid var(--green);
    border-radius: 8px;
    background: rgba(0, 255, 136, 0.1);
    color: var(--green);
    font-family: 'Inter', sans-serif;
    font-size: 13px;
    font-weight: 600;
    cursor: pointer;
    transition: var(--transition);
    white-space: nowrap;
    flex-shrink: 0;
  }

  .download-btn:hover {
    background: rgba(0, 255, 136, 0.18);
    box-shadow: var(--glow-green);
    transform: translateY(-1px);
  }

  .download-all-btn {
    width: 100%;
    padding: 14px;
    border: 1px solid rgba(0, 240, 255, 0.15);
    border-radius: var(--radius-sm);
    background: transparent;
    color: var(--cyan);
    font-family: 'Inter', sans-serif;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: var(--transition);
    margin-top: 4px;
  }

  .download-all-btn:hover {
    background: rgba(0, 240, 255, 0.05);
    border-color: var(--cyan);
    box-shadow: 0 0 15px rgba(0, 240, 255, 0.08);
  }

  /* ==================== Log ==================== */
  .log-area {
    background: rgba(0, 0, 0, 0.6);
    border: 1px solid rgba(0, 240, 255, 0.06);
    border-radius: var(--radius-sm);
    padding: 16px;
    max-height: 320px;
    overflow-y: auto;
    font-family: 'JetBrains Mono', 'Fira Code', 'Cascadia Code', monospace;
    font-size: 12px;
    line-height: 1.8;
    color: var(--text-secondary);
  }

  .log-area::-webkit-scrollbar { width: 6px; }
  .log-area::-webkit-scrollbar-track { background: transparent; }
  .log-area::-webkit-scrollbar-thumb {
    background: rgba(0, 240, 255, 0.15);
    border-radius: 3px;
  }

  .log-line { white-space: pre-wrap; word-break: break-all; }
  .log-line.info    { color: var(--green); text-shadow: 0 0 6px rgba(0, 255, 136, 0.3); }
  .log-line.warn    { color: var(--amber); }
  .log-line.error   { color: var(--red); text-shadow: 0 0 6px rgba(239, 68, 68, 0.3); }
  .log-line.title   { color: var(--cyan); font-weight: 600; text-shadow: 0 0 8px rgba(0, 240, 255, 0.4); }
  .log-line.stats   { color: var(--blue); }

  /* ==================== Spinner ==================== */
  .spinner {
    display: inline-block;
    width: 16px;
    height: 16px;
    border: 2px solid rgba(0, 240, 255, 0.2);
    border-top-color: var(--cyan);
    border-radius: 50%;
    animation: spin 0.6s linear infinite;
    vertical-align: middle;
    margin-right: 8px;
  }

  @keyframes spin { to { transform: rotate(360deg); } }

  /* ==================== Footer ==================== */
  .footer {
    margin-top: 48px;
    text-align: center;
    color: var(--text-muted);
    font-size: 12px;
  }

  .footer a {
    color: var(--cyan);
    text-decoration: none;
  }

  /* ==================== Responsive ==================== */
  @media (max-width: 640px) {
    .container { padding: 24px 16px 60px; }
    .header h1 { font-size: 1.8rem; }
    .card { padding: 20px; }
    .drop-zone { padding: 32px 16px; }
    .result-item { flex-direction: column; gap: 12px; align-items: stretch; }
    .download-btn { width: 100%; text-align: center; }
  }
</style>
</head>
<body>

<div class="container">

  <!-- Header -->
  <div class="header">
    <div class="header-badge">Browser-Side Converter</div>
    <h1>OpenClash é…ç½®è½¬æ¢å™¨</h1>
    <p>ä¸Šä¼ åŸå§‹è®¢é˜… YAML â†’ ä¸€é”®ç”Ÿæˆ OpenClash æ™®é€šç‰ˆ + Lite ç²¾ç®€ç‰ˆé…ç½®</p>
  </div>

  <!-- Upload Card -->
  <div class="card" id="uploadCard">
    <div class="card-title">
      <span class="icon upload">ğŸ“„</span>
      ä¸Šä¼ è®¢é˜…æ–‡ä»¶
    </div>
    <div class="drop-zone" id="dropZone">
      <input type="file" id="fileInput" accept=".yaml,.yml">
      <span class="upload-icon">â¬†ï¸</span>
      <div class="main-text">æ‹–æ‹½ YAML æ–‡ä»¶åˆ°è¿™é‡Œï¼Œæˆ–ç‚¹å‡»é€‰æ‹©</div>
      <div class="sub-text">æ”¯æŒ .yaml / .yml æ ¼å¼çš„ Clash è®¢é˜…æ–‡ä»¶</div>
    </div>
    <div class="file-info" id="fileInfo">
      <div class="file-icon">ğŸ“‹</div>
      <div class="file-details">
        <div class="file-name" id="fileName">-</div>
        <div class="file-size" id="fileSize">-</div>
      </div>
      <button class="file-remove" id="fileRemove" title="ç§»é™¤">âœ•</button>
    </div>
    <button class="convert-btn" id="convertBtn" disabled>ğŸš€ å¼€å§‹è½¬æ¢</button>
  </div>

  <!-- Results Card -->
  <div class="card results-section" id="resultsCard">
    <div class="card-title">
      <span class="icon output">ğŸ“¦</span>
      è½¬æ¢ç»“æœ
    </div>
    <div id="resultsList"></div>
    <button class="download-all-btn" id="downloadAllBtn">ğŸ“¥ å…¨éƒ¨ä¸‹è½½</button>
  </div>

  <!-- Log Card -->
  <div class="card">
    <div class="card-title">
      <span class="icon log">ğŸ“Ÿ</span>
      è½¬æ¢æ—¥å¿—
    </div>
    <div class="log-area" id="logArea">
      <div class="log-line" style="color: var(--text-muted);">ç­‰å¾…ä¸Šä¼ æ–‡ä»¶...</div>
    </div>
  </div>

  <div class="footer">
    OpenClash Config Converter &middot; çº¯æµè§ˆå™¨ç«¯è½¬æ¢ï¼Œæ–‡ä»¶ä¸ä¼šä¸Šä¼ åˆ°ä»»ä½•æœåŠ¡å™¨
  </div>
</div>

<!--
  å¼•å…¥å¤–éƒ¨ä¾èµ–ï¼š
  1. js-yaml.js â€” UMD æ ¼å¼ï¼Œæµè§ˆå™¨ç¯å¢ƒè‡ªåŠ¨æŒ‚è½½åˆ° window.jsyaml
  2. Clash.js â€” çº¯å…¨å±€è„šæœ¬ï¼Œæš´éœ²å…¨å±€ main() å‡½æ•°å’Œç›¸å…³é…ç½®å˜é‡
-->
<script src="js-yaml.js"></script>
<script src="Clash.js"></script>

<script>
/**
 * ============================================================
 *  æµè§ˆå™¨ç«¯è½¬æ¢é€»è¾‘
 *  å°† convert.js å’Œ convertLite.js çš„ Node.js é€»è¾‘é‡å†™ä¸ºæµè§ˆå™¨ç‰ˆæœ¬
 *  - å»é™¤ fsã€pathã€process ç­‰ Node.js ä¾èµ–
 *  - ä½¿ç”¨ jsyaml (window.jsyaml) æ›¿ä»£ require('./js-yaml.js')
 *  - ä½¿ç”¨å…¨å±€ main() æ›¿ä»£ require('./Clash.js') çš„æ²™ç®±æ‰§è¡Œ
 * ============================================================
 */
(function () {
  'use strict';

  // ==================== DOM å¼•ç”¨ ====================
  const dropZone    = document.getElementById('dropZone');
  const fileInput   = document.getElementById('fileInput');
  const fileInfo    = document.getElementById('fileInfo');
  const fileName    = document.getElementById('fileName');
  const fileSize    = document.getElementById('fileSize');
  const fileRemove  = document.getElementById('fileRemove');
  const convertBtn  = document.getElementById('convertBtn');
  const resultsCard = document.getElementById('resultsCard');
  const resultsList = document.getElementById('resultsList');
  const downloadAll = document.getElementById('downloadAllBtn');
  const logArea     = document.getElementById('logArea');

  // ==================== çŠ¶æ€ ====================
  let rawYamlContent = null;   // ç”¨æˆ·ä¸Šä¼ çš„åŸå§‹ YAML æ–‡æœ¬
  let sourceFileName = '';     // åŸå§‹æ–‡ä»¶å
  let outputBlobs = {};        // { full: { blob, name, stats }, lite: { blob, name, stats } }

  // ==================== æ—¥å¿—å·¥å…· ====================
  function clearLog() {
    logArea.innerHTML = '';
  }

  function log(msg, type = '') {
    const line = document.createElement('div');
    line.className = 'log-line' + (type ? ' ' + type : '');
    line.textContent = msg;
    logArea.appendChild(line);
    logArea.scrollTop = logArea.scrollHeight;
  }

  // ==================== æ–‡ä»¶ä¸Šä¼  ====================
  dropZone.addEventListener('click', () => fileInput.click());

  dropZone.addEventListener('dragover', (e) => {
    e.preventDefault();
    dropZone.classList.add('drag-over');
  });

  dropZone.addEventListener('dragleave', () => {
    dropZone.classList.remove('drag-over');
  });

  dropZone.addEventListener('drop', (e) => {
    e.preventDefault();
    dropZone.classList.remove('drag-over');
    const file = e.dataTransfer.files[0];
    if (file) handleFile(file);
  });

  fileInput.addEventListener('change', () => {
    const file = fileInput.files[0];
    if (file) handleFile(file);
  });

  fileRemove.addEventListener('click', () => {
    rawYamlContent = null;
    sourceFileName = '';
    fileInput.value = '';
    fileInfo.classList.remove('visible');
    convertBtn.disabled = true;
    resultsCard.classList.remove('visible');
    outputBlobs = {};
    clearLog();
    log('ç­‰å¾…ä¸Šä¼ æ–‡ä»¶...', '');
  });

  function handleFile(file) {
    if (!file.name.match(/\.ya?ml$/i)) {
      log('âŒ ä»…æ”¯æŒ .yaml / .yml æ–‡ä»¶', 'error');
      return;
    }
    sourceFileName = file.name;
    fileName.textContent = file.name;
    fileSize.textContent = formatSize(file.size);
    fileInfo.classList.add('visible');

    const reader = new FileReader();
    reader.onload = (e) => {
      rawYamlContent = e.target.result;
      convertBtn.disabled = false;
      clearLog();
      log('ğŸ“„ æ–‡ä»¶å·²åŠ è½½: ' + file.name, 'info');
      log('   å¤§å°: ' + formatSize(file.size), '');
    };
    reader.readAsText(file, 'utf-8');
  }

  function formatSize(bytes) {
    if (bytes < 1024) return bytes + ' B';
    if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
    return (bytes / (1024 * 1024)).toFixed(2) + ' MB';
  }

  // ==================== è½¬æ¢æŒ‰é’® ====================
  convertBtn.addEventListener('click', () => {
    if (!rawYamlContent) return;
    // å¼‚æ­¥æ‰§è¡Œï¼Œè®© UI å…ˆæ›´æ–°
    convertBtn.disabled = true;
    convertBtn.innerHTML = '<span class="spinner"></span>è½¬æ¢ä¸­...';
    resultsCard.classList.remove('visible');
    outputBlobs = {};
    clearLog();
    setTimeout(runConversion, 50);
  });

  // ==================== æ ¸å¿ƒè½¬æ¢é€»è¾‘ ====================
  function runConversion() {
    try {
      // ========== Step 1: è§£æåŸå§‹ YAML ==========
      log('â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—', 'title');
      log('â•‘         OpenClash é…ç½®è½¬æ¢ (æµè§ˆå™¨ç‰ˆ)             â•‘', 'title');
      log('â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•', 'title');
      log('');

      let config = jsyaml.load(rawYamlContent);
      log('ğŸ“¥ å·²åŠ è½½åŸå§‹è®¢é˜…: ' + sourceFileName, 'info');

      // ========== Step 2: æ‰§è¡Œ Clash.js çš„ main() ==========
      // main() æ˜¯ Clash.js æš´éœ²çš„å…¨å±€å‡½æ•°
      log('âœ… Clash.js è„šæœ¬å·²åŠ è½½ï¼ˆé€šè¿‡ <script src> å¼•å…¥ï¼‰', 'info');
      config = main(config);
      log('âœ… main() æ‰§è¡Œå®Œæ¯•', 'info');

      // ========== Step 3: convert.js çš„åå¤„ç†é€»è¾‘ ==========

      // A. è¿‡æ»¤è·¯ç”±å™¨ä¸æ”¯æŒçš„è§„åˆ™ç±»å‹ï¼ˆPROCESS ç›¸å…³ï¼‰
      if (config.rules && Array.isArray(config.rules)) {
        const originalCount = config.rules.length;
        config.rules = config.rules.filter((rule) => {
          return !/^PROCESS-(NAME|PATH|NAME-REGEX|PATH-REGEX),/i.test(rule);
        });
        const removedCount = originalCount - config.rules.length;
        if (removedCount > 0) {
          log('âœ… å·²è¿‡æ»¤ ' + removedCount + ' æ¡è·¯ç”±å™¨ä¸æ”¯æŒçš„è¿›ç¨‹è§„åˆ™', 'info');
        }
      }

      // B. ä¿®æ­£ Rule Provider è·¯å¾„ (é€‚é… Linux/OpenWrt)
      if (config['rule-providers']) {
        Object.keys(config['rule-providers']).forEach((key) => {
          const provider = config['rule-providers'][key];
          if (provider.path) {
            // æå–æ–‡ä»¶åéƒ¨åˆ†ï¼ˆæµè§ˆå™¨ç«¯ä¸èƒ½ç”¨ path.basenameï¼Œæ‰‹åŠ¨å®ç°ï¼‰
            const parts = provider.path.replace(/\\/g, '/').split('/');
            const baseName = parts[parts.length - 1];
            provider.path = '/etc/openclash/rule_provider/' + baseName;
          }
        });
        log('âœ… Rule Providers è·¯å¾„å·²ä¿®æ­£', 'info');
      }

      // C. æ¸…ç† OpenClash ç”¨ä¸ä¸Šçš„é…ç½®é¡¹
      const fieldsToRemove = [
        'cfw-latency-timeout', 'cfw-conn-break-strategy', 'cfw-bypass', 'cfw-profiles',
        'tun', 'external-ui', 'external-ui-url',
        'mixed-port', 'redir-port', 'tproxy-port', 'external-controller',
      ];
      fieldsToRemove.forEach((field) => delete config[field]);
      log('âœ… å·²æ¸…ç†è½¯è·¯ç”±ç”¨ä¸ä¸Šçš„é…ç½®é¡¹', 'info');

      // D. å¼ºåˆ¶ geodata-mode ä¸º false
      config['geodata-mode'] = false;
      log('âœ… geodata-mode å·²è®¾ä¸º falseï¼ˆåˆ†ç¦»æ¨¡å¼ï¼‰', 'info');

      // ========== Step 4: ç”Ÿæˆæ™®é€šç‰ˆ YAML ==========
      const fullYaml = jsyaml.dump(config, { lineWidth: -1 });
      const baseName = sourceFileName.replace(/\.ya?ml$/i, '');
      const fullFileName = baseName + '_openclash.yaml';
      const fullBlob = new Blob([fullYaml], { type: 'application/x-yaml;charset=utf-8' });

      const fullStats = {
        proxies: config.proxies?.length || 0,
        groups: config['proxy-groups']?.length || 0,
        rules: config.rules?.length || 0,
        providers: Object.keys(config['rule-providers'] || {}).length,
      };

      outputBlobs.full = { blob: fullBlob, name: fullFileName, stats: fullStats };

      log('', '');
      log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•', 'stats');
      log('ğŸ“Š æ™®é€šç‰ˆç»Ÿè®¡:', 'stats');
      log('   ä»£ç†èŠ‚ç‚¹: ' + fullStats.proxies + ' ä¸ª', 'stats');
      log('   ç­–ç•¥ç»„: ' + fullStats.groups + ' ä¸ª', 'stats');
      log('   è§„åˆ™: ' + fullStats.rules + ' æ¡', 'stats');
      log('   è§„åˆ™é›†: ' + fullStats.providers + ' ä¸ª', 'stats');
      log('   è¾“å‡ºæ–‡ä»¶: ' + fullFileName, 'stats');
      log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•', 'stats');

      // ========== Step 5: ç”Ÿæˆ Lite ç‰ˆ (convertLite.js é€»è¾‘) ==========
      log('', '');
      log('â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—', 'title');
      log('â•‘         OpenClash æç®€ç‰ˆè½¬æ¢ (Lite)               â•‘', 'title');
      log('â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•', 'title');

      // æ·±æ‹·è´ä¸€ä»½ config ç”¨äº Lite å¤„ç†
      let liteConfig = jsyaml.load(jsyaml.dump(config, { lineWidth: -1 }));

      const originalProxyCount = liteConfig.proxies?.length || 0;
      const originalGroupCount = liteConfig['proxy-groups']?.length || 0;

      // è¿‡æ»¤ä»£ç†èŠ‚ç‚¹ï¼šä¿ç•™"å®éªŒæ€§"èŠ‚ç‚¹ + å€ç‡ < 1x çš„èŠ‚ç‚¹
      // æœªæ ‡æ³¨å€ç‡çš„æ™®é€šèŠ‚ç‚¹è§†ä¸º 1xï¼Œä¸ä¿ç•™
      const liteMultiplierRegex = /(?<=[xXâœ•âœ–â¨‰å€ç‡])([1-9]+(\.\d+)*|0{1}\.\d+)(?=[xXâœ•âœ–â¨‰å€ç‡])*/i;
      if (liteConfig.proxies && Array.isArray(liteConfig.proxies)) {
        liteConfig.proxies = liteConfig.proxies.filter((proxy) => {
          const specialNodes = ['ç›´è¿', 'DIRECT', 'REJECT', 'æ‹’ç»', 'å…¨çƒç›´è¿'];
          if (specialNodes.some((s) => proxy.name.includes(s))) return true;
          if (proxy.name.includes('å®éªŒæ€§')) return true;
          // æœ‰æ˜¾å¼å€ç‡æ ‡æ³¨ä¸” < 1 çš„èŠ‚ç‚¹ä¿ç•™
          const match = liteMultiplierRegex.exec(proxy.name);
          if (match) return parseFloat(match[1]) < 1;
          return false; // æ— å€ç‡æ ‡æ³¨çš„æ™®é€šèŠ‚ç‚¹ä¸ä¿ç•™
        });
      }

      const remainingProxyNames = new Set(
        (liteConfig.proxies || []).map((p) => p.name)
      );

      log('âœ… ä»£ç†èŠ‚ç‚¹: ' + originalProxyCount + ' -> ' + remainingProxyNames.size + ' (ä»…ä¿ç•™"å®éªŒæ€§"èŠ‚ç‚¹)', 'info');

      // æ›´æ–°ç­–ç•¥ç»„ä¸­çš„èŠ‚ç‚¹å¼•ç”¨
      if (liteConfig['proxy-groups'] && Array.isArray(liteConfig['proxy-groups'])) {
        liteConfig['proxy-groups'] = liteConfig['proxy-groups']
          .map((group) => {
            if (group.proxies && Array.isArray(group.proxies)) {
              const groupNames = new Set(
                liteConfig['proxy-groups'].map((g) => g.name)
              );
              group.proxies = group.proxies.filter((proxyName) => {
                const builtInPolicies = ['DIRECT', 'REJECT', 'ç›´è¿', 'æ‹’ç»'];
                return (
                  remainingProxyNames.has(proxyName) ||
                  groupNames.has(proxyName) ||
                  builtInPolicies.includes(proxyName)
                );
              });
            }
            return group;
          })
          .filter((group) => group.proxies && group.proxies.length > 0);
      }

      // åˆ é™¤å„åœ°åŒºçš„è‡ªåŠ¨æµ‹é€Ÿåˆ†ç»„ï¼ˆç»Ÿä¸€"è‡ªåŠ¨æµ‹é€Ÿ"å·²åœ¨ Clash.js ä¸­åˆ›å»ºï¼‰
      if (liteConfig['proxy-groups']) {
        liteConfig['proxy-groups'] = liteConfig['proxy-groups'].filter(
          (group) => !group.name.startsWith('è‡ªåŠ¨æµ‹é€Ÿ-')
        );

        // æ›¿æ¢æ‰€æœ‰åˆ†ç»„ä¸­å¯¹"è‡ªåŠ¨æµ‹é€Ÿ-XXX"çš„å¼•ç”¨ä¸º"è‡ªåŠ¨æµ‹é€Ÿ"
        liteConfig['proxy-groups'] = liteConfig['proxy-groups'].map((group) => {
          if (group.proxies) {
            group.proxies = group.proxies.map((proxyName) => {
              if (proxyName.startsWith('è‡ªåŠ¨æµ‹é€Ÿ-')) {
                return 'è‡ªåŠ¨æµ‹é€Ÿ';
              }
              return proxyName;
            });
            group.proxies = [...new Set(group.proxies)];
          }
          return group;
        });
      }

      // äºŒæ¬¡æ¸…ç†ï¼šç§»é™¤å¼•ç”¨äº†å·²åˆ é™¤åˆ†ç»„çš„èŠ‚ç‚¹
      let prevCount = -1;
      while (
        prevCount !== (liteConfig['proxy-groups']?.length || 0) &&
        liteConfig['proxy-groups']
      ) {
        prevCount = liteConfig['proxy-groups'].length;
        const validGroupNames = new Set(
          liteConfig['proxy-groups'].map((g) => g.name)
        );

        liteConfig['proxy-groups'] = liteConfig['proxy-groups']
          .map((group) => {
            if (group.proxies) {
              group.proxies = group.proxies.filter((proxyName) => {
                const builtInPolicies = ['DIRECT', 'REJECT', 'ç›´è¿', 'æ‹’ç»'];
                return (
                  remainingProxyNames.has(proxyName) ||
                  validGroupNames.has(proxyName) ||
                  builtInPolicies.includes(proxyName)
                );
              });
            }
            return group;
          })
          .filter((group) => group.proxies && group.proxies.length > 0);
      }

      const finalGroupCount = liteConfig['proxy-groups']?.length || 0;
      log('âœ… ç­–ç•¥åˆ†ç»„: ' + originalGroupCount + ' -> ' + finalGroupCount + ' (å·²ç§»é™¤ç©ºåˆ†ç»„)', 'info');

      // ç”Ÿæˆ Lite ç‰ˆ YAML
      const liteYaml = jsyaml.dump(liteConfig, { lineWidth: -1 });
      const liteFileName = baseName + '_lite.yaml';
      const liteBlob = new Blob([liteYaml], { type: 'application/x-yaml;charset=utf-8' });

      const liteStats = {
        proxies: liteConfig.proxies?.length || 0,
        proxiesOrig: originalProxyCount,
        groups: finalGroupCount,
        groupsOrig: originalGroupCount,
        rules: liteConfig.rules?.length || 0,
        providers: Object.keys(liteConfig['rule-providers'] || {}).length,
      };

      outputBlobs.lite = { blob: liteBlob, name: liteFileName, stats: liteStats };

      log('', '');
      log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•', 'stats');
      log('ğŸ“Š Lite ç‰ˆç»Ÿè®¡:', 'stats');
      log('   ä»£ç†èŠ‚ç‚¹: ' + liteStats.proxies + ' ä¸ª (åŸ ' + liteStats.proxiesOrig + ' ä¸ª)', 'stats');
      log('   ç­–ç•¥ç»„: ' + liteStats.groups + ' ä¸ª (åŸ ' + liteStats.groupsOrig + ' ä¸ª)', 'stats');
      log('   è§„åˆ™: ' + liteStats.rules + ' æ¡', 'stats');
      log('   è§„åˆ™é›†: ' + liteStats.providers + ' ä¸ª', 'stats');
      log('   è¾“å‡ºæ–‡ä»¶: ' + liteFileName, 'stats');
      log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•', 'stats');

      log('', '');
      log('âœ… å…¨éƒ¨è½¬æ¢å®Œæˆï¼', 'info');

      // ========== Step 6: æ¸²æŸ“ç»“æœ ==========
      renderResults();

    } catch (err) {
      log('', '');
      log('âŒ è½¬æ¢å¤±è´¥: ' + err.message, 'error');
      if (err.stack) {
        log(err.stack, 'error');
      }
    } finally {
      convertBtn.disabled = false;
      convertBtn.innerHTML = 'ğŸš€ å¼€å§‹è½¬æ¢';
    }
  }

  // ==================== æ¸²æŸ“ç»“æœ ====================
  function renderResults() {
    resultsList.innerHTML = '';

    if (outputBlobs.full) {
      const s = outputBlobs.full.stats;
      resultsList.innerHTML += createResultItem(
        'full', 'Full', 'æ™®é€šç‰ˆ',
        outputBlobs.full.name,
        s.proxies + ' èŠ‚ç‚¹ Â· ' + s.groups + ' åˆ†ç»„ Â· ' + s.rules + ' è§„åˆ™ Â· ' + s.providers + ' è§„åˆ™é›†'
      );
    }

    if (outputBlobs.lite) {
      const s = outputBlobs.lite.stats;
      resultsList.innerHTML += createResultItem(
        'lite', 'Lite', 'ç²¾ç®€ç‰ˆ',
        outputBlobs.lite.name,
        s.proxies + ' èŠ‚ç‚¹ Â· ' + s.groups + ' åˆ†ç»„ Â· ' + s.rules + ' è§„åˆ™ Â· ' + s.providers + ' è§„åˆ™é›†'
      );
    }

    resultsCard.classList.add('visible');

    // ç»‘å®šä¸‹è½½äº‹ä»¶
    document.querySelectorAll('.download-btn[data-type]').forEach((btn) => {
      btn.addEventListener('click', () => {
        const type = btn.getAttribute('data-type');
        if (outputBlobs[type]) {
          triggerDownload(outputBlobs[type].blob, outputBlobs[type].name);
        }
      });
    });
  }

  function createResultItem(type, badge, label, name, statsText) {
    return `
      <div class="result-item">
        <div class="result-info">
          <span class="result-badge ${type}">${badge}</span>
          <div class="result-meta">
            <div class="result-name">${name}</div>
            <div class="result-stats">${statsText}</div>
          </div>
        </div>
        <button class="download-btn" data-type="${type}">ğŸ“¥ ä¸‹è½½${label}</button>
      </div>
    `;
  }

  // ==================== ä¸‹è½½å·¥å…· ====================
  function triggerDownload(blob, filename) {
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    setTimeout(() => URL.revokeObjectURL(url), 5000);
  }

  downloadAll.addEventListener('click', () => {
    Object.keys(outputBlobs).forEach((key) => {
      const item = outputBlobs[key];
      if (item) triggerDownload(item.blob, item.name);
    });
  });

})();
</script>

</body>
</html>
